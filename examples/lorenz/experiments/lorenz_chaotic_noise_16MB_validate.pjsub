#!/bin/bash -x
#
#PJM -L "node=132"    
#PJM -L "rscgrp=small"
#PJM -L "proc-openfd=1048576"
#PJM -L "elapse=12:00:00"
#PJM --mpi "proc=6336"
#PJM --llio localtmp-size=80Gi
#PJM -s

# MPI DEBUG FLAGS
# -fjdbg-sig all  : write backtrace when terminate signal caught
# -fjdbg-dlock    : write deadlock backtrace when job ends 

# un/comment for debug on/off
#export MELISSA_MPI_DBG_FLAG="-fjdbg-dlock"
#export MELISSA_MPI_DBG_FLAG="-fjdbg-sig all"
#
export STATE_SIZE=16 # MB [NOTE: only statesize of 512, 1024 and 2048 !!!]
export TIME_TO_WRITE_TRACE=14400 # seconds

export EXP_SOURCE_PATH="/home/ra000012/a04454/LAB/Melissa/melissa-da-particle-filter/examples/lorenz"
export EXP_BASE_PATH="/2ndfs/ra000012/a04454"
#export EXP_OBS_DIR="/2ndfs/ra000012/a04454/obs_${STATE_SIZE}MB"
export EXP_OBS_DIR="/2ndfs/ra000012/a04454/obs_16MB_chaotic"
#export EXP_BASE_PATH="${PWD}"

# ----------------------------------------------------------------------
#  SOURCE MELISSA STUFF
# ----------------------------------------------------------------------

. /home/ra000012/a04454/LAB/Melissa/env.sh

# ----------------------------------------------------------------------
#  OBSERVATION SETTINGS
# ----------------------------------------------------------------------

export STATE_SIZE_ELEM=`expr $STATE_SIZE \/ 8 \* 1048576`

export MELISSA_LORENZ_NUM_RUNNERS=25
export MELISSA_LORENZ_NUM_VALIDATORS=100
export MELISSA_LORENZ_RUNNER_GROUP_SIZE=$(( (MELISSA_LORENZ_NUM_RUNNERS + 128 + 2 - 1)/128 ))
export MELISSA_LORENZ_PROCS_RUNNERS=48
export MELISSA_LORENZ_NODES_RUNNERS=1
export MELISSA_LORENZ_MEMBERS=100
export MELISSA_LORENZ_OBSERVATION_BLOCK_SIZE=1024
export MELISSA_LORENZ_ITER_MAX=20
export MELISSA_LORENZ_OBSERVATION_PERCENT=20
export MELISSA_LORENZ_STATE_DIMENSION=$STATE_SIZE_ELEM
export MELISSA_LORENZ_OBSERVATION_DIR="$EXP_OBS_DIR"

#NSEC=`date +%s`
#echo "copying observations into the local directory..."
#for i in `seq 0 $MELISSA_LORENZ_ITER_MAX`; do
#  llio_transfer $EXP_OBS_DIR/iter-${i}.obs
#done
#echo "transfer took `expr $(date +%s) \- $NSEC` seconds"

echo "starting simulation with $MELISSA_LORENZ_NUM_RUNNERS runners and $MELISSA_LORENZ_MEMBERS particles"

# ----------------------------------------------------------------------
#  PERFORM EXPERIMENT
# ----------------------------------------------------------------------

export MELISSA_LORENZ_TIMING_TRACE=$TIME_TO_WRITE_TRACE

export EXP_TIME=`TZ=UTC-2 date +%^a-%d%m%Y-%H%M`
export MELISSA_LORENZ_EXPERIMENT_DIR=${EXP_BASE_PATH}/EXP_LORENZ_M${MELISSA_LORENZ_NUM_RUNNERS}_${STATE_SIZE}MB_${EXP_TIME}
mkdir -p $MELISSA_LORENZ_EXPERIMENT_DIR && cp ${EXP_SOURCE_PATH}/script.py $MELISSA_LORENZ_EXPERIMENT_DIR && cd $MELISSA_LORENZ_EXPERIMENT_DIR

echo "starting simulation with $MELISSA_LORENZ_NUM_RUNNERS runners and $MELISSA_LORENZ_MEMBERS particles"
echo "---| experiment directory: $MELISSA_LORENZ_EXPERIMENT_DIR"
echo "---| observation directory: $MELISSA_LORENZ_OBSERVATION_DIR"
echo "---| state size: $STATE_SIZE MB"
echo "---| number of runners: $MELISSA_LORENZ_NUM_RUNNERS"
echo "---| number of particles: $MELISSA_LORENZ_MEMBERS"

python3 -u script.py > $MELISSA_LORENZ_EXPERIMENT_DIR/launcher.out 2>&1
